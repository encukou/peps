PEP: 9999
Title: Guidelines for Python's C API
Author: Petr Viktorin <encukou@gmail.com>,
Discussions-To: https://discuss.python.org/c/c-api/30
Status: Draft
Type: Process
Requires: 731
Created: 20-Nov-2023
Post-History: XXX

.. pep-banner::

   This is a **draft informational PEP**, published for initial discussion.
   It is likely to be amended substantially.
   It does not represent consensus, or binding rules, yet.

.. Authors to be added:

        Guido van Rossum <guido@python.org>,
        Victor Stinner <vstinner@python.org>,
        Steve Dower <steve.dower@python.org>,
        Irit Katriel <irit@python.org>


Abstract
========

XXX Write the abstract last.


About this document
===================

[MERGED IN api-evolution]


High-level goals
================

[MERGED IN api-evolution]


Meta-guidelines
===============

Don't panic!
------------

[SOME MERGED IN api-evolution]


We do not expect you, fellow CPython contributor, to read and remember
all of the guidelines.
If you have any doubt, ask the C API working group for clarifications
or help in API design.

To help you apply the guidelines, this document sometimes repeats information.
If you find that the guidelines contradict themselves, please ask the C API
working group to clarify.


Working group approvals
-----------------------

[MERGED IN api-evolution]


Exceptions to the guidelines
----------------------------

[MERGED IN api-evolution]


Applicability
=============

[MERGED IN api-evolution]


API tiers
---------

[MERGED IN api-evolution]


One header
==========

[MERGED IN api-evolution]


.. XXX add a PEP number prefix to the anchor:

.. _naming:

Naming
======

[MERGED IN api-evolution EXCEPT THE FOLLOWING]

.. XXX NOT IN PR NOT IN PR NOT IN PR NOT IN PR NOT IN PR NOT IN PR :

For common API concepts, use terms from :ref:`glossary`.
Avoid synonyms, and avoid using glossary names for unrelated concepts.


Do not reuse names
------------------

[MERGED IN api-evolution]


Language support
================

C standard and dialect
----------------------

[MERGED IN api-evolution EXCEPT THE FOLLOWING]

Prefer ``static inline`` functions to macros where reasonable.


Portable subset of C
--------------------

[MERGED EXCEPT:]

.. ref. https://github.com/capi-workgroup/api-evolution/issues/37 (Declare constants as variables, instead of macros)

*  Prefer ``const`` symbols over macros for exposing constant values.



.. XXX add a PEP number prefix to the anchor:

.. _types:

Types
=====

Scalars
-------

[MERGED (as Arithmetic types & Enums and bitfields)]


Structs
-------

.. ref. https://github.com/capi-workgroup/api-evolution/issues/27 Structs
.. ref. https://github.com/capi-workgroup/api-evolution/issues/8 Blueprint structs

All structs in new API must be one of the following:

*  Opaque structs, whose members and size are not part of the public API.
   These are handled via pointers.
*  “Blueprint” structs, used to pass information when e.g. creating a new object.
   (We don't have examples or a good design of these yet. Please coordinate
   with the C API working group if you want to add one.)
*  Simple interoperability structs, whose members and size are part of the API
   and ABI, e.g. ``Py_complex``.
   ``Py_buffer`` is at -- or maybe even past -- the limit of what counts
   as “simple”.


Objects
-------

[SOME MERGED IN api-evolution EXCEPT:]

See :ref:`ownership` for reference counting guidelines.

Return values
=============


[MERGED except a ref]

.. ref. https://github.com/capi-workgroup/api-evolution/issues/5


.. XXX add a PEP number prefix to the anchor:

.. _output argument:

Output arguments
================

[MERGED with a TODO to link to "ownership"]

* Ownership of the result is transferred to the caller, as with return values.
  See :ref:`ownership` for details. [!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!]


Function behavior
=================

Do not suppress exceptions
--------------------------

.. ref. https://github.com/capi-workgroup/api-evolution/issues/35

Functions must not suppress unknown exceptions, except ones that specifically
do just that (e.g. ``PyErr_Clear``).


Do not allow mutating immutable objects
---------------------------------------

.. ref. https://github.com/capi-workgroup/api-evolution/issues/20

If an object is immutable in Python, C API may not mutate it either.

It is of course fine to mutate implementation details: refcounts, lazily
computed attributes and so on.

Note that current API like ``PyUnicode_WRITE`` allows mutation to create an
object, and it's up to the user to not use this API once the object is no
longer “fresh”.
If you want to add something similar, don't follow this precedent.
Instead, contact the C API workgroup so we can design a better API.


Do not allow creating incomplete/invalid objects
------------------------------------------------

.. ref. https://github.com/capi-workgroup/api-evolution/issues/36

C API should not allow creating objects that cannot be immediately safely
used from Python code.

This rule is most important for -- but not limited to -- the GC protocol:

* A traverse function must be safe to call right after an object
  is tracked with the GC.
* Do not avoid creating objects that need additional API calls, which the
  user can easily forget, before an object is usable.
  For example, adding to the GC.


.. XXX add a PEP number prefix to the anchor:

.. _ownership:

Managing ownership
==================

.. ref. https://github.com/capi-workgroup/api-evolution/issues/16 Reference handling
.. ref. https://github.com/capi-workgroup/api-evolution/issues/17 Document lifetimes & ownership rules
.. ref. https://github.com/capi-workgroup/api-evolution/issues/25

For new API, the ownership rules and lifetimes of all arguments and return
values need to be well defined.

All API must hold a **reference** to any data it manipulates, except data
that's passed by value (numeric types and simple structs such as
``Py_complex``).

Background and terminology
--------------------------

A *reference* is a pointer with extra abstract semantics. References come in
two flavors:

*  A *strong* or **owned reference** means that the *owner* is responsible for
   disposing of the reference.

   The **owner** is most often a piece of code that's being executed
   (with the reference being a local variable), a container (with the
   reference being a field in the instance struct), or the interpreter itself.
   Statically allocated data is, conceptually, owned by the *process*.

*  A **borrowed** reference means a copy of a reference held by another
   owner, with some guarantee in place that it will stay valid
   while it's being borrowed.

   Note that a reference may be borrowed from another borrowed reference.

The owner of a strong reference can **transfer ownership** to a new owner.
Afterwards, the old owner should either:

* not use the reference any more, or
* treat it as *borrowed* from the new owner, as long as the new owner
  guarantees the reference stays valid.

There are two kinds of resources with managed ownership:

*  ``PyObject *``, which we use for all reference-counted resources.

   Borrowed references to ``PyObject *`` may be converted to strong ones
   via ``Py_NewRef`` or similar.

* Non-reference-counted resources, such as allocated memory.

  These only allow one strong reference.


Input arguments
---------------

By default, references passed as function arguments are *borrowed references*.
That is:

* The caller is responsible for keeping the reference valid for the duration
  of the call.
* The callee must not assume that the reference stays valid after the call
  returns. (For example, to store it in a global, it would need tor create
  a new reference and store that.)

:ref:`Output arguments <output argument>` (pointers to memory that the
function fills) are instead treated as *results*, see below.


Results
-------

By default, ownership of function results (return values and
:ref:`Output arguments <output argument>`) is transferred to the caller.
That is:

* After the call, the caller owns the resulting reference.
* The callee must not assume the result stays valid after it's return.


Exceptions to the defaults
--------------------------

Transferring ownership of arguments
'''''''''''''''''''''''''''''''''''

For input arguments, the alternative to the default is
*transferring ownership* of the argument, known informally as “stealing”.

This is allowed in the following cases:

*  Functions that destroy references or resources, like ``Py_DecRef``.
   These should include a word like ``DecRef``, ``Close``, ``Free`` or
   ``Dealloc`` in the name (see :ref:`glossary`).

   Use ``Clear`` when the reference pointer is set to ``NULL``, as in
   ``Py_CLEAR``.

*  Functions that turn a non-reference-counted resource into a different object,
   destroying the resource (or even repurposing its memory in-place).
   These should include ``Consume`` in the name (see :ref:`glossary`).

*  Functions that work on statically allocated data (which is “borrowed” from
   the process itself).
   These should include ``Static`` in the name (see :ref:`glossary`).

*  Another “stealing” function may be added as an alternative to a function
   that borrows arguments. Usually, this is needed for performance.

   The guidelines for this are not finalized;
   please contact the C API workgroup if you need it.

   .. XXX we need to decide if "steal" is acceptable in API names

      * it is an alternative to a function that transfers ownership,
      * it includes ``Steal`` in the name (see :ref:`glossary`),
      * its docs explicitly say that ownership of argument(s) is transferred.
         (Note that docs should use the long proper term, *transfer of ownership*;
         keep ``Steal`` in the API name.)


Returning borrowed references
'''''''''''''''''''''''''''''

The results, the alternative to the default is returning
a *borrowed reference*.

*  Only add a function that returns a borrowed reference as an alternative
   to a function that transfers ownership.
*  Include ``Borrow`` in the name (see :ref:`glossary`).
*  Documentation should be very explicit; for example::

     The returned reference is borrowed from X
     (that is: it is only valid as long as you hold a reference to X).
     To get a :term:`strong reference`, use Y or- Z.

   * “The returned reference is borrowed from p” -- the lender is crucial
     information
   * “that is” -- emphasizes that “borrowed from X” and “only valid as long as
     you hold a reference to X” are equivalent
   * “only valid as long as you hold a reference to p” -- this should be
     spelled out rather than e.g. hidden behind a glossary link.
   * “To get a strong reference...” -- there should always be an alternative
     that gives you a strong ref.

Make sure the documentation lists *Return value: Borrowed reference*,
   and explicitly describes the conditions under which the borrowed reference
   is valid. (For example: *``None`` is borrowed from the interpreter and
   is valid until interpreter shutdown.*)


Nested references
-----------------

When designing and documenting lifetime and ownership, pay special attention to
pointers inside ``struct``, and arrays of pointers.
Always consider the lifetime & ownership of both the container itself and
the items in it.

Strings
-------

Treat strings (``const char*``) as non-reference-counted references.
In particular, make sure the API does not implicitly assume 
that strings provided by the user are ``static``.


Documentation and tests
=======================

Public API must have proper documentation and tests.

Function documentation should explicitly specify what the return values are,
what output arguments are initialized to, and when an exception is set.


.. XXX add a PEP number prefix to the anchor:

.. _glossary:

Appendix A. C API Naming Glossary
=================================

.. ref. https://github.com/capi-workgroup/api-evolution/issues/23
.. ref. https://github.com/capi-workgroup/api-evolution/issues/25 (managing ownership)

Use these terms for naming APIs whenever applicable.
They are generally used as suffixes.

-  ``From<type>`` (e.g. ``PyLong_FromLong``): creates an object
-  ``As<type>`` (e.g. ``PyLong_AsLong``): converts to a C type
-  ``Get``: Retrieve a value (no side effect except allocation/refcounting)
- ``Va``: Takes varargs
-  ``Object`` (in functions): Takes a Python object rather than a native type
   (e.g. ``PyImport_AddModuleObject(PyObject*)`` vs.
   ``PyImport_AddModule(char*)``)
-  ``Object`` (in types, e.g. ``PyLongObject``): The instance struct.
   Omit the underscore before ``Object`` (it's not ``PyLong_Object``).
-  ``_<typename>`` (``_PyObject_CallFunction_SizeT``): Has an unexpected
   argument/return type, or a different type than a similar function
-  ``_impl``: "Inner" function that has a wrapper. Used e.g. by
   Argument Clinic and C-specific speedups.
   The API should almost always be marked private (``_Py``).

Names for exceptions to rules
-----------------------------

-  ``Unchecked``: Doesn't validate a (pre)condition that's normally checked
-  ``Unsafe``: Doesn't uphold some invariant that users expect
-  Terms from the :ref:`managing ownership <ownership>` section:
   - ``Borrow``
   - (XXX take ownership of an argument: name not finalized)
   - ``Consume``
   - ``DecRef``, ``Close``, ``Free``, ``Dealloc``
   - ``Clear`` (also used for emptying a container)
   - ``Static``


Names for “evolved” versions of API
-----------------------------------

-  ``Ref``: Returns a new reference
-  ``WithError``: Has proper error handling
-  ``With*`` (``WithKeywords``, ``WithBases``, etc.):
   Takes an additional argument.
-  ``Flags``: Takes additional flags
-  ``Ex``: Takes additional arguments. Avoid this; use a more specific name.

Terms to avoid
--------------

- ``New``
- ``Fast``
- ``Ex``


.. XXX add a PEP number prefix to the anchor:

.. _shadowing example:

Appendix B. Shadowing example
=============================

[MERGED as Appendix A]


.. XXX add a PEP number prefix to the anchor:

.. _return schemes:

Appendix C. Return value schemes
================================

[MERGED as Appendix B]


Changelog
=========

* XX-XXX-2024: Initial approved version


Copyright
=========

This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.


XXX
=========

Argument *names* should generally be included in declarations,
but may be omitted if the meaning is obvious.
